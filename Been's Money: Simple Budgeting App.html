<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Been's Money</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Custom Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Define CSS variables for theming */
        :root {
            --theme-bg: #1a202c;
            --theme-bg-secondary: #2d3748;
            --theme-text: #e2e8f0;
            --theme-text-secondary: #a0aec0;
            --theme-income: #38a169;
            --theme-income-hover: #2f855a;
            --theme-border: #4a5568;
            --theme-expense: #e53e3e;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--theme-bg);
            color: var(--theme-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--theme-bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--theme-income); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--theme-income-hover); }
        
        /* Modal animation */
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }

        /* View toggle button style */
        .view-toggle-btn {
            transition: background-color 0.2s, color 0.2s;
        }
        .view-toggle-btn.active {
            background-color: var(--theme-income);
            color: white;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 id="app-title" class="text-2xl sm:text-3xl font-bold">Been's Money</h1>
                <p id="app-tagline" class="text-xs" style="color: var(--theme-text-secondary);">Simple Budgeting App</p>
            </div>
            <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </header>

        <!-- Dashboard -->
        <main>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="md:col-span-1 grid grid-cols-1 gap-4">
                    <div class="p-4 rounded-lg shadow-lg" style="background-color: var(--theme-bg-secondary);">
                        <h3 class="text-sm font-medium" style="color: var(--theme-text-secondary);">Current Balance</h3>
                        <p id="balance" class="text-2xl font-bold" style="color: var(--theme-income);">Rp 0</p>
                    </div>
                    <div class="p-4 rounded-lg shadow-lg" style="background-color: var(--theme-bg-secondary);">
                        <h3 id="expense-title" class="text-sm font-medium" style="color: var(--theme-text-secondary);">Monthly Expense</h3>
                        <p id="total-expense" class="text-2xl font-bold" style="color: var(--theme-expense);">Rp 0</p>
                    </div>
                </div>
                <div class="md:col-span-2 p-4 rounded-lg shadow-lg flex flex-col justify-center items-center" style="background-color: var(--theme-bg-secondary);">
                    <h3 id="flow-title" class="text-sm font-medium text-center mb-4" style="color: var(--theme-text-secondary);">Monthly Flow</h3>
                    <div id="flow-visual-container" class="w-full px-4">
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-left">
                                <p class="text-xs" style="color: var(--theme-income);">Income</p>
                                <p id="flow-income-label" class="text-sm font-semibold" style="color: var(--theme-income);">Rp 0</p>
                            </div>
                            <div class="text-center">
                                <p id="flow-ratio" class="text-xl font-bold">0%</p>
                                <p class="text-xs" style="color: var(--theme-text-secondary);">Spent</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs" style="color: var(--theme-expense);">Expense</p>
                                <p id="flow-expense-label" class="text-sm font-semibold" style="color: var(--theme-expense);">Rp 0</p>
                            </div>
                        </div>
                        <div class="w-full h-3 rounded-full" style="background-color: var(--theme-income);">
                            <div id="flow-bar-expense" class="h-3 rounded-full" style="background-color: var(--theme-expense); width: 0%; transition: width 0.5s ease-in-out;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="p-4 rounded-lg shadow-lg" style="background-color: var(--theme-bg-secondary);">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h2 class="text-xl font-semibold mb-2 sm:mb-0">Transaction History</h2>
                    <div class="flex flex-wrap gap-2">
                        <button id="delete-period-btn" class="text-sm py-2 px-3 rounded-lg transition-colors flex items-center" style="background-color: var(--theme-bg); color: var(--theme-expense); border: 1px solid var(--theme-expense);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            Delete Period Data
                        </button>
                        <button id="export-pdf-btn" class="text-sm py-2 px-3 rounded-lg transition-colors flex items-center" style="background-color: var(--theme-bg); color: var(--theme-text-secondary); border: 1px solid var(--theme-border);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                            Export PDF
                        </button>
                         <button id="export-csv-btn" class="text-sm py-2 px-3 rounded-lg transition-colors flex items-center" style="background-color: var(--theme-bg); color: var(--theme-text-secondary); border: 1px solid var(--theme-border);">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            Export CSV
                        </button>
                        <button id="add-transaction-btn" class="text-sm font-semibold text-white py-2 px-3 rounded-lg transition-colors flex items-center" style="background-color: var(--theme-income);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Add Transaction
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-between items-center my-4">
                    <div class="p-1 rounded-lg" style="background-color: var(--theme-bg);">
                        <button id="month-view-btn" class="view-toggle-btn py-1 px-3 text-sm rounded-md">Month</button>
                        <button id="year-view-btn" class="view-toggle-btn py-1 px-3 text-sm rounded-md">Year</button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="prev-period-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">&lt;</button>
                        <h3 id="current-period-display" class="text-lg font-semibold text-center w-48"></h3>
                        <button id="next-period-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">&gt;</button>
                    </div>
                </div>

                <div id="transaction-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
            </div>
        </main>
        
        <footer class="text-center mt-8 space-x-4">
            <a href="https://instagram.com/beenspace" target="_blank" class="text-xs transition-colors" style="color: var(--theme-text-secondary); hover:color: var(--theme-text);">IG: @beenspace</a>
            <a href="https://github.com/muqorrobinize" target="_blank" class="text-xs transition-colors" style="color: var(--theme-text-secondary); hover:color: var(--theme-text);">GH: @muqorrobinize</a>
        </footer>
    </div>

    <!-- Modals -->
    <div id="transaction-modal" class="modal fixed inset-0 z-50 items-center justify-center hidden" style="background-color: rgba(0,0,0,0.6);">
        <div class="modal-content w-full max-w-md p-6 rounded-lg shadow-xl m-4" style="background-color: var(--theme-bg-secondary);">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">Add New Transaction</h2>
            <form id="transaction-form" autocomplete="off">
                <input type="hidden" id="transaction-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1" style="color: var(--theme-text-secondary);">Transaction Type</label>
                    <select id="transaction-type" class="w-full p-2 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);" required>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="transaction-amount" class="block text-sm font-medium mb-1" style="color: var(--theme-text-secondary);">Amount (Rp)</label>
                    <input type="number" id="transaction-amount" class="w-full p-2 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);" placeholder="e.g. 50000" required>
                </div>
                <div class="mb-4">
                    <label for="transaction-category" class="block text-sm font-medium mb-1" style="color: var(--theme-text-secondary);">Category</label>
                    <select id="transaction-category" class="w-full p-2 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);" required></select>
                </div>
                <div class="mb-4">
                    <label for="transaction-date" class="block text-sm font-medium mb-1" style="color: var(--theme-text-secondary);">Date</label>
                    <input type="date" id="transaction-date" class="w-full p-2 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);" required>
                </div>
                <div class="mb-4">
                    <label for="transaction-description" class="block text-sm font-medium mb-1" style="color: var(--theme-text-secondary);">Description (Optional)</label>
                    <input type="text" id="transaction-description" class="w-full p-2 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);" placeholder="e.g. Buying a book">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-transaction-btn" class="py-2 px-4 rounded-lg" style="background-color: var(--theme-border);">Cancel</button>
                    <button type="submit" id="save-transaction-btn" class="py-2 px-4 rounded-lg text-white" style="background-color: var(--theme-income);">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="settings-modal" class="modal fixed inset-0 z-50 items-center justify-center hidden" style="background-color: rgba(0,0,0,0.6);">
        <div class="modal-content w-full max-w-lg p-6 rounded-lg shadow-xl m-4" style="background-color: var(--theme-bg-secondary);">
            <h2 class="text-2xl font-bold mb-6">Settings</h2>
            <div class="mb-6">
                <label for="username" class="block text-sm font-medium mb-1" style="color: var(--theme-text-secondary);">Username</label>
                <input type="text" id="username" class="w-full p-2 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);" placeholder="Your Name">
            </div>

            <h3 class="font-semibold mb-2">Color Customization</h3>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-xs font-medium mb-1" style="color: var(--theme-text-secondary);">Base</label>
                    <input type="color" id="theme-color-base" class="w-full p-1 h-10 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);">
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1" style="color: var(--theme-text-secondary);">Block</label>
                    <input type="color" id="theme-color-block" class="w-full p-1 h-10 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);">
                </div>
                 <div>
                    <label class="block text-xs font-medium mb-1" style="color: var(--theme-text-secondary);">Font</label>
                    <input type="color" id="theme-color-text" class="w-full p-1 h-10 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);">
                </div>
                 <div>
                    <label class="block text-xs font-medium mb-1" style="color: var(--theme-text-secondary);">Font 2</label>
                    <input type="color" id="theme-color-text-secondary" class="w-full p-1 h-10 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);">
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1" style="color: var(--theme-text-secondary);">Border</label>
                    <input type="color" id="theme-color-border" class="w-full p-1 h-10 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);">
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1" style="color: var(--theme-text-secondary);">Income</label>
                    <input type="color" id="theme-color-income" class="w-full p-1 h-10 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);">
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1" style="color: var(--theme-text-secondary);">Expense</label>
                    <input type="color" id="theme-color-expense" class="w-full p-1 h-10 rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);">
                </div>
            </div>

            <h3 class="font-semibold mb-2">Category Management</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <div id="income-category-list" class="space-y-2 mb-2 max-h-32 overflow-y-auto pr-2"></div>
                    <form id="add-income-category-form" class="flex space-x-2">
                        <input type="text" id="new-income-category" class="flex-grow p-2 text-sm rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);" placeholder="New income category...">
                        <button type="submit" class="p-2 rounded text-white" style="background-color: var(--theme-income);">+</button>
                    </form>
                </div>
                <div>
                    <div id="expense-category-list" class="space-y-2 mb-2 max-h-32 overflow-y-auto pr-2"></div>
                    <form id="add-expense-category-form" class="flex space-x-2">
                        <input type="text" id="new-expense-category" class="flex-grow p-2 text-sm rounded border" style="background-color: var(--theme-bg); border-color: var(--theme-border);" placeholder="New expense category...">
                        <button type="submit" class="p-2 rounded text-white" style="background-color: var(--theme-income);">+</button>
                    </form>
                </div>
            </div>

            <div class="flex justify-end">
                <button id="save-settings-btn" class="py-2 px-5 rounded-lg text-white" style="background-color: var(--theme-income);">Save & Close</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal fixed inset-0 z-50 items-center justify-center hidden" style="background-color: rgba(0,0,0,0.6);">
        <div class="modal-content w-full max-w-sm p-6 rounded-lg shadow-xl m-4" style="background-color: var(--theme-bg-secondary);">
            <h3 class="text-lg font-bold mb-4">Confirm Deletion</h3>
            <p id="confirm-message" class="mb-6" style="color: var(--theme-text-secondary);">Are you sure you want to delete this item?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="py-2 px-4 rounded-lg" style="background-color: var(--theme-border);">Cancel</button>
                <button id="confirm-delete-btn" class="py-2 px-4 rounded-lg bg-red-600 text-white">Delete</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300" style="background-color: var(--theme-income);">
        <p id="toast-message"></p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const { jsPDF } = window.jspdf;

        // --- DOM Elements ---
        const appTitle = document.getElementById('app-title');
        const balanceEl = document.getElementById('balance');
        const totalExpenseEl = document.getElementById('total-expense');
        const transactionListEl = document.getElementById('transaction-list');
        const addTransactionBtn = document.getElementById('add-transaction-btn');
        const transactionModal = document.getElementById('transaction-modal');
        const transactionForm = document.getElementById('transaction-form');
        const cancelTransactionBtn = document.getElementById('cancel-transaction-btn');
        const transactionTypeSelect = document.getElementById('transaction-type');
        const transactionCategorySelect = document.getElementById('transaction-category');
        const modalTitle = document.getElementById('modal-title');
        
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const usernameInput = document.getElementById('username');
        const themeColorBaseInput = document.getElementById('theme-color-base');
        const themeColorBlockInput = document.getElementById('theme-color-block');
        const themeColorTextInput = document.getElementById('theme-color-text');
        const themeColorTextSecondaryInput = document.getElementById('theme-color-text-secondary');
        const themeColorBorderInput = document.getElementById('theme-color-border');
        const themeColorIncomeInput = document.getElementById('theme-color-income');
        const themeColorExpenseInput = document.getElementById('theme-color-expense');

        const incomeCategoryListEl = document.getElementById('income-category-list');
        const addIncomeCategoryForm = document.getElementById('add-income-category-form');
        const expenseCategoryListEl = document.getElementById('expense-category-list');
        const addExpenseCategoryForm = document.getElementById('add-expense-category-form');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        const exportCsvBtn = document.getElementById('export-csv-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const deletePeriodBtn = document.getElementById('delete-period-btn');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        const monthViewBtn = document.getElementById('month-view-btn');
        const yearViewBtn = document.getElementById('year-view-btn');
        const prevPeriodBtn = document.getElementById('prev-period-btn');
        const nextPeriodBtn = document.getElementById('next-period-btn');
        const currentPeriodDisplay = document.getElementById('current-period-display');
        
        const expenseTitle = document.getElementById('expense-title');
        const flowTitle = document.getElementById('flow-title');
        const flowIncomeLabel = document.getElementById('flow-income-label');
        const flowExpenseLabel = document.getElementById('flow-expense-label');
        const flowBarExpense = document.getElementById('flow-bar-expense');
        const flowRatio = document.getElementById('flow-ratio');

        // --- State Management ---
        let state = {
            transactions: [],
            username: 'Been',
            theme: {
                base: '#1a202c',
                block: '#2d3748',
                text: '#e2e8f0',
                textSecondary: '#a0aec0',
                border: '#4a5568',
                income: '#38a169',
                expense: '#e53e3e',
            },
            incomeCategories: ['Salary', 'Pocket Money', 'Scholarship', 'Gifts'],
            expenseCategories: ['Food & Drink', 'Transportation', 'Shopping', 'Education', 'Entertainment', 'Bills'],
            viewMode: 'month', // 'month' or 'year'
        };
        let displayedDate = new Date();
        let deleteCallback = null;

        // --- Utility Functions ---
        const formatCurrency = (amount, prefix = 'Rp ') => `${prefix}${new Intl.NumberFormat('id-ID').format(amount)}`;
        const getTodayDate = () => new Date().toISOString().split('T')[0];
        const showToast = (message) => {
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        };
        const openModal = (modal) => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.querySelector('.modal-content').style.transform = 'scale(1)';
            }, 10);
        };
        const closeModal = (modal) => {
            modal.style.opacity = '0';
            modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        };

        // --- Data Persistence ---
        const saveData = () => localStorage.setItem('budgetAppData_v4', JSON.stringify(state));
        const loadData = () => {
            const data = localStorage.getItem('budgetAppData_v4');
            if (data) {
                // Merge loaded data with default state to prevent errors if new properties are added
                const loadedState = JSON.parse(data);
                state = {...state, ...loadedState};
                state.theme = {...state.theme, ...loadedState.theme};
            }
        };

        // --- Theme Management ---
        const applyTheme = () => {
            const root = document.documentElement;
            root.style.setProperty('--theme-bg', state.theme.base);
            root.style.setProperty('--theme-bg-secondary', state.theme.block);
            root.style.setProperty('--theme-text', state.theme.text);
            root.style.setProperty('--theme-text-secondary', state.theme.textSecondary);
            root.style.setProperty('--theme-border', state.theme.border);
            root.style.setProperty('--theme-income', state.theme.income);
            root.style.setProperty('--theme-expense', state.theme.expense);
            const hoverColor = shadeColor(state.theme.income, -15);
            root.style.setProperty('--theme-income-hover', hoverColor);
            appTitle.textContent = `${state.username}'s Money`;
            document.title = `${state.username}'s Money`;
        };

        function shadeColor(color, percent) {
            let R = parseInt(color.substring(1, 3), 16);
            let G = parseInt(color.substring(3, 5), 16);
            let B = parseInt(color.substring(5, 7), 16);
            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);
            R = Math.max(0, Math.min(255, R));
            G = Math.max(0, Math.min(255, G));
            B = Math.max(0, Math.min(255, B));
            return "#" + [R, G, B].map(x => x.toString(16).padStart(2, '0')).join('');
        }

        // --- Rendering Functions ---
        const getTransactionsForPeriod = () => {
            const year = displayedDate.getFullYear();
            if (state.viewMode === 'year') {
                return state.transactions.filter(t => new Date(t.date).getFullYear() === year);
            }
            // else, month view
            const month = displayedDate.getMonth();
            return state.transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getMonth() === month && tDate.getFullYear() === year;
            });
        };

        const renderAll = () => {
            const transactionsForPeriod = getTransactionsForPeriod();
            renderDashboard(transactionsForPeriod);
            renderTransactions(transactionsForPeriod);
            updateFlowVisual(transactionsForPeriod);
            updatePeriodDisplay();
            updateViewToggleButtons();
        };

        const renderDashboard = (transactionsForPeriod) => {
            const totalIncome = state.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = state.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpense;
            const currentPeriodExpense = transactionsForPeriod.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            balanceEl.textContent = formatCurrency(balance);
            totalExpenseEl.textContent = formatCurrency(currentPeriodExpense);
            
            const isYearView = state.viewMode === 'year';
            expenseTitle.textContent = isYearView ? 'Yearly Expense' : 'Monthly Expense';
            flowTitle.textContent = isYearView ? 'Yearly Flow' : 'Monthly Flow';
        };

        const renderTransactions = (transactionsForPeriod) => {
            transactionListEl.innerHTML = '';
            if (transactionsForPeriod.length === 0) {
                transactionListEl.innerHTML = `<p class="text-center py-8" style="color: var(--theme-text-secondary);">No transactions for this period.</p>`;
                return;
            }
            const sorted = [...transactionsForPeriod].sort((a, b) => new Date(b.date) - new Date(a.date));
            sorted.forEach(t => {
                const isIncome = t.type === 'income';
                const amountClass = isIncome ? 'text-green-400' : 'text-red-400';
                const sign = isIncome ? '+' : '-';
                const date = new Date(t.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                const el = document.createElement('div');
                el.className = 'flex items-center justify-between p-3 rounded-lg';
                el.style.backgroundColor = 'var(--theme-bg)';
                el.innerHTML = `
                    <div class="flex items-center">
                        <div class="p-2 rounded-full mr-3" style="background-color: ${isIncome ? 'rgba(56, 161, 105, 0.2)' : 'rgba(229, 62, 62, 0.2)'};">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${isIncome ? 'var(--theme-income)' : 'var(--theme-expense)'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${isIncome ? '<line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline>' : '<line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline>'}</svg>
                        </div>
                        <div>
                            <p class="font-semibold">${t.description || t.category}</p>
                            <p class="text-xs" style="color: var(--theme-text-secondary);">${t.category} • ${date}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold ${amountClass}">${sign} ${formatCurrency(t.amount)}</p>
                        <div class="flex items-center justify-end space-x-2 mt-1">
                            <button class="edit-btn text-xs" data-id="${t.id}" style="color: var(--theme-text-secondary);"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="delete-btn text-xs" data-id="${t.id}" style="color: var(--theme-text-secondary);"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                        </div>
                    </div>`;
                transactionListEl.appendChild(el);
            });
        };

        const renderCategoriesInSettings = () => {
            const renderList = (listEl, categories, type) => {
                listEl.innerHTML = '';
                categories.forEach(cat => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 text-sm rounded';
                    div.style.backgroundColor = 'var(--theme-bg)';
                    div.innerHTML = `<span>${cat}</span><button class="delete-category-btn text-red-500" data-category="${cat}" data-type="${type}">×</button>`;
                    listEl.appendChild(div);
                });
            };
            renderList(incomeCategoryListEl, state.incomeCategories, 'income');
            renderList(expenseCategoryListEl, state.expenseCategories, 'expense');
        };

        const populateCategorySelect = () => {
            const type = transactionTypeSelect.value;
            const categories = type === 'income' ? state.incomeCategories : state.expenseCategories;
            transactionCategorySelect.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
        };

        const updatePeriodDisplay = () => {
            if (state.viewMode === 'year') {
                currentPeriodDisplay.textContent = displayedDate.getFullYear();
            } else {
                currentPeriodDisplay.textContent = displayedDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            }
        };
        
        const updateViewToggleButtons = () => {
            monthViewBtn.classList.toggle('active', state.viewMode === 'month');
            yearViewBtn.classList.toggle('active', state.viewMode === 'year');
        };

        const updateFlowVisual = (transactionsForPeriod) => {
            const periodIncome = transactionsForPeriod.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const periodExpense = transactionsForPeriod.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const ratio = periodIncome > 0 ? Math.min(Math.round((periodExpense / periodIncome) * 100), 100) : 0;

            flowIncomeLabel.textContent = formatCurrency(periodIncome);
            flowExpenseLabel.textContent = formatCurrency(periodExpense);
            flowRatio.textContent = `${ratio}%`;

            flowBarExpense.style.width = `${ratio}%`;
        };
        
        // --- Event Handlers ---
        addTransactionBtn.addEventListener('click', () => {
            transactionForm.reset();
            document.getElementById('transaction-id').value = '';
            document.getElementById('transaction-date').value = getTodayDate();
            modalTitle.textContent = 'Add New Transaction';
            populateCategorySelect();
            openModal(transactionModal);
        });
        cancelTransactionBtn.addEventListener('click', () => closeModal(transactionModal));
        transactionTypeSelect.addEventListener('change', populateCategorySelect);
        transactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('transaction-id').value;
            const newTransaction = {
                id: id || Date.now().toString(),
                type: document.getElementById('transaction-type').value,
                amount: parseFloat(document.getElementById('transaction-amount').value),
                category: document.getElementById('transaction-category').value,
                date: document.getElementById('transaction-date').value,
                description: document.getElementById('transaction-description').value,
            };
            if (id) {
                state.transactions = state.transactions.map(t => t.id === id ? newTransaction : t);
            } else {
                state.transactions.push(newTransaction);
            }
            saveData();
            renderAll();
            closeModal(transactionModal);
            showToast('Transaction saved successfully!');
        });
        transactionListEl.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                const transaction = state.transactions.find(t => t.id === editBtn.dataset.id);
                if (transaction) {
                    modalTitle.textContent = 'Edit Transaction';
                    document.getElementById('transaction-id').value = transaction.id;
                    document.getElementById('transaction-type').value = transaction.type;
                    populateCategorySelect();
                    document.getElementById('transaction-amount').value = transaction.amount;
                    document.getElementById('transaction-category').value = transaction.category;
                    document.getElementById('transaction-date').value = transaction.date;
                    document.getElementById('transaction-description').value = transaction.description;
                    openModal(transactionModal);
                }
            }
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                confirmMessage.textContent = 'Are you sure you want to delete this transaction?';
                deleteCallback = () => {
                    state.transactions = state.transactions.filter(t => t.id !== deleteBtn.dataset.id);
                    saveData();
                    renderAll();
                    showToast('Transaction deleted.');
                };
                openModal(confirmModal);
            }
        });

        settingsBtn.addEventListener('click', () => {
            usernameInput.value = state.username;
            themeColorBaseInput.value = state.theme.base;
            themeColorBlockInput.value = state.theme.block;
            themeColorTextInput.value = state.theme.text;
            themeColorTextSecondaryInput.value = state.theme.textSecondary;
            themeColorBorderInput.value = state.theme.border;
            themeColorIncomeInput.value = state.theme.income;
            themeColorExpenseInput.value = state.theme.expense;
            renderCategoriesInSettings();
            openModal(settingsModal);
        });
        saveSettingsBtn.addEventListener('click', () => {
            state.username = usernameInput.value || 'Been';
            state.theme.base = themeColorBaseInput.value;
            state.theme.block = themeColorBlockInput.value;
            state.theme.text = themeColorTextInput.value;
            state.theme.textSecondary = themeColorTextSecondaryInput.value;
            state.theme.border = themeColorBorderInput.value;
            state.theme.income = themeColorIncomeInput.value;
            state.theme.expense = themeColorExpenseInput.value;
            saveData();
            applyTheme();
            renderAll();
            closeModal(settingsModal);
        });
        const handleAddCategory = (e, type) => {
            e.preventDefault();
            const input = document.getElementById(`new-${type}-category`);
            const newCategory = input.value.trim();
            if (newCategory && !state[`${type}Categories`].includes(newCategory)) {
                state[`${type}Categories`].push(newCategory);
                saveData();
                renderCategoriesInSettings();
                input.value = '';
            }
        };
        addIncomeCategoryForm.addEventListener('submit', (e) => handleAddCategory(e, 'income'));
        addExpenseCategoryForm.addEventListener('submit', (e) => handleAddCategory(e, 'expense'));
        document.getElementById('settings-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-category-btn')) {
                const category = e.target.dataset.category;
                const type = e.target.dataset.type;
                confirmMessage.textContent = `Delete category "${category}"?`;
                deleteCallback = () => {
                    state[`${type}Categories`] = state[`${type}Categories`].filter(c => c !== category);
                    saveData();
                    renderCategoriesInSettings();
                    showToast('Category deleted.');
                };
                openModal(confirmModal);
            }
        });
        cancelDeleteBtn.addEventListener('click', () => closeModal(confirmModal));
        confirmDeleteBtn.addEventListener('click', () => {
            if (deleteCallback) deleteCallback();
            deleteCallback = null;
            closeModal(confirmModal);
        });
        
        deletePeriodBtn.addEventListener('click', () => {
            const transactionsForPeriod = getTransactionsForPeriod();
            if (transactionsForPeriod.length === 0) {
                showToast('No data to delete in this period.');
                return;
            }
            
            const periodName = currentPeriodDisplay.textContent;
            confirmMessage.textContent = `Are you sure you want to delete all ${transactionsForPeriod.length} transactions for ${periodName}? This cannot be undone.`;
            
            deleteCallback = () => {
                const year = displayedDate.getFullYear();
                if (state.viewMode === 'year') {
                    state.transactions = state.transactions.filter(t => new Date(t.date).getFullYear() !== year);
                } else {
                    const month = displayedDate.getMonth();
                    state.transactions = state.transactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate.getFullYear() !== year || tDate.getMonth() !== month;
                    });
                }
                saveData();
                renderAll();
                showToast(`All data for ${periodName} deleted.`);
            };
            
            openModal(confirmModal);
        });

        exportCsvBtn.addEventListener('click', () => {
            if (state.transactions.length === 0) return showToast('No data to export.');
            let csvContent = "data:text/csv;charset=utf-8,Date,Type,Category,Amount,Description\r\n";
            state.transactions.forEach(t => {
                const row = [t.date, t.type, t.category, t.amount, `"${t.description || ''}"`].join(",");
                csvContent += row + "\r\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `${state.username}_budget_export_all.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('CSV exported successfully!');
        });
        exportPdfBtn.addEventListener('click', () => {
            const transactionsForPeriod = getTransactionsForPeriod();
            if (transactionsForPeriod.length === 0) return showToast('No data in this period to export.');
            const doc = new jsPDF();
            const periodName = currentPeriodDisplay.textContent;
            doc.setFontSize(18);
            doc.text(`Financial Report for ${periodName}`, 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Generated for: ${state.username}`, 14, 29);
            const income = transactionsForPeriod.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expense = transactionsForPeriod.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            doc.autoTable({
                startY: 40,
                head: [['Summary', 'Amount']],
                body: [['Total Income', formatCurrency(income)], ['Total Expense', formatCurrency(expense)], ['Net Flow', formatCurrency(income - expense)]],
                theme: 'striped',
                headStyles: { fillColor: [38, 166, 154] }
            });
            const tableData = transactionsForPeriod.map(t => [
                new Date(t.date).toLocaleDateString('en-GB'),
                t.type.charAt(0).toUpperCase() + t.type.slice(1),
                t.category,
                t.description || '-',
                formatCurrency(t.amount, '')
            ]);
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                head: [['Date', 'Type', 'Category', 'Description', 'Amount (Rp)']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [45, 55, 72] }
            });
            doc.save(`Budget_Report_${periodName.replace(' ', '_')}.pdf`);
            showToast('PDF exported successfully!');
        });

        monthViewBtn.addEventListener('click', () => {
            state.viewMode = 'month';
            renderAll();
        });
        yearViewBtn.addEventListener('click', () => {
            state.viewMode = 'year';
            renderAll();
        });
        prevPeriodBtn.addEventListener('click', () => {
            if (state.viewMode === 'year') {
                displayedDate.setFullYear(displayedDate.getFullYear() - 1);
            } else {
                displayedDate.setMonth(displayedDate.getMonth() - 1);
            }
            renderAll();
        });
        nextPeriodBtn.addEventListener('click', () => {
            if (state.viewMode === 'year') {
                displayedDate.setFullYear(displayedDate.getFullYear() + 1);
            } else {
                displayedDate.setMonth(displayedDate.getMonth() + 1);
            }
            renderAll();
        });

        // --- Initial Load ---
        loadData();
        applyTheme();
        renderAll();

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal(transactionModal);
                closeModal(settingsModal);
                closeModal(confirmModal);
            }
        });
    });
    </script>
</body>
</html>
